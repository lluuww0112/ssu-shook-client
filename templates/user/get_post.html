<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê²Œì‹œê¸€ ëª©ë¡ ì¡°íšŒ</title>
    <style>
        body {
            font-family: "Segoe UI", sans-serif;
            background-color: #f7f7f7;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: start;
            min-height: 100vh;
        }
        .page {
            width: 90%;
            max-width: 800px;
            margin-top: 60px;
            background: white;
            padding: 50px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }
        h2 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
        }
        .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            justify-content: center;
        }
        .form-row input, .form-row select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 15px;
        }
        .form-row button {
            background-color: #6c5ce7;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        .form-row button:hover {
            background-color: #4b44c2;
        }
        .post {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 20px;
            background: #f9f9ff;
        }
        .post h3 {
            margin: 0 0 10px;
            font-size: 17px;
        }
        .club-name {
            font-weight: bold;
            color: #6c5ce7;
            margin-bottom: 8px;
        }
        .post-meta {
            font-size: 13px;
            color: #888;
            margin-bottom: 8px;
        }
        .post-content {
            margin-bottom: 8px;
        }
        .back-button {
            display: block;
            margin: 30px auto 0;
            background-color: #6c5ce7;
            color: white;
            padding: 10px 24px;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            cursor: pointer;
        }
        .back-button:hover {
            background-color: #4b44c2;
        }
        .message {
            position: fixed;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            min-width: 280px;
            max-width: 90vw;
            background: #fff3f3;
            color: #e17055;
            border: 1px solid #ffb3b3;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            padding: 16px 40px 16px 20px;
            border-radius: 8px;
            font-size: 17px;
            z-index: 9999;
            text-align: left;
            display: none;
        }
        .message.show {
            display: block;
        }
        .message .close-btn {
            position: absolute;
            top: 10px;
            right: 16px;
            font-size: 20px;
            color: #e17055;
            background: none;
            border: none;
            cursor: pointer;
            outline: none;
        }
    </style>
</head>
<body>
<div id="message" class="message" style="display:none;"></div>
<div class="page">
    <h2>ğŸ“‹ ê²Œì‹œê¸€ ëª©ë¡ ì¡°íšŒ</h2>
    <form id="searchForm" class="form-row">
        <input type="text" id="clubName" placeholder="ë™ì•„ë¦¬ëª… (ì˜ˆ: ë¹›ëˆ„ë¦¬)" />
        <select id="postType">
            <option value="">ê²Œì‹œê¸€ íƒ€ì… ì „ì²´</option>
            <option value="activity">ë™ì•„ë¦¬ í™œë™</option>
            <option value="recruiting">ë¦¬í¬ë£¨íŒ…</option>
            <option value="union">ì—°í•©í™œë™</option>
        </select>
        <button type="submit">ì¡°íšŒ</button>
    </form>
    <form id="singlePostForm" class="form-row" style="margin-bottom:20px;">
        <input type="text" id="singlePostID" placeholder="ê²Œì‹œê¸€ ID ì…ë ¥ (ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ê¸°)" style="width:320px;" />
        <button type="submit">íŠ¹ì • ê²Œì‹œê¸€ ì¡°íšŒ</button>
    </form>
    <div id="singlePostResult"></div>
    <div id="postList"></div>
    <button class="back-button" onclick="goBack()">â¬…ï¸ ëŒì•„ê°€ê¸°</button>
</div>
<script>
function goBack() {
    if (document.referrer) {
        history.back();
    } else {
        location.href = "/home";
    }
}

function formatDate(dateStr) {
    if (!dateStr) return "-";
    const d = new Date(dateStr);
    return d.toLocaleString("ko-KR", { timeZone: "Asia/Seoul" });
}

function showMessage(msg) {
    const messageDiv = document.getElementById("message");
    messageDiv.innerHTML = `${msg}<button class='close-btn' onclick='hideMessage()'>&times;</button>`;
    messageDiv.classList.add("show");
    messageDiv.style.display = "block";
}

function hideMessage() {
    const messageDiv = document.getElementById("message");
    messageDiv.classList.remove("show");
    messageDiv.style.display = "none";
}

async function fetchPosts(clubName, postType) {
    document.getElementById("postList").innerHTML = "ì¡°íšŒ ì¤‘...";
    try {
        const res = await fetch("/user/get_posts", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                club_name: clubName || null,
                post_type: postType || null
            })
        });
        const data = await res.json();
        if (data.status === 1) {
            if (Array.isArray(data.results)) {
                renderPosts(data.results);
                if (data.results.length === 0) {
                    showMessage("ê²Œì‹œê¸€ì´ ì¡°íšŒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                }
            } else if (typeof data.results === "string" && data.results === "ê²Œì‹œê¸€ì´ ì¡°íšŒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤") {
                document.getElementById("postList").innerHTML = "";
                showMessage(data.results);
            } else {
                // ë©”ì‹œì§€ ìœ ì§€ (hideMessage í˜¸ì¶œí•˜ì§€ ì•ŠìŒ)
            }
        } else {
            document.getElementById("postList").innerHTML = "";
            showMessage(data.message || "ê²Œì‹œê¸€ì„ ì¡°íšŒí•˜ëŠ” ë„ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤");
        }
    } catch (e) {
        document.getElementById("postList").innerHTML = "";
        showMessage("ê²Œì‹œê¸€ì„ ì¡°íšŒí•˜ëŠ” ë„ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤");
    }
}

function renderPosts(posts) {
    const postList = document.getElementById("postList");
    postList.innerHTML = "";
    posts.sort((a, b) => new Date(b.added) - new Date(a.added)); // ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
    posts.forEach(post => {
        const div = document.createElement("div");
        div.className = "post";
        div.innerHTML = `
            <div class="club-name">${post.club_name}</div>
            <h3>${post.title}</h3>
            <div class="post-meta">
                <span>íƒ€ì…: ${post.post_type}</span> |
                <span>ê²Œì‹œì¼: ${post.added ? formatDate(post.added) : '-'}</span> |
                <span>ìˆ˜ì •ì¼: ${post.updated ? formatDate(post.updated) : '-'}</span>
            </div>
            <div class="post-content">${post.text}</div>
            <div style="font-size:12px;color:#bbb;">ID: ${post.post_ID}</div>
        `;
        postList.appendChild(div);
    });
}

function renderSinglePost(post) {
    const container = document.getElementById("singlePostResult");
    if (!post) {
        container.innerHTML = "";
        return;
    }
    let html = `<div class='post'>`;
    html += `<div class='club-name'>${post.club_name}</div>`;
    html += `<h3>${post.title}</h3>`;
    html += `<div class='post-meta'>`;
    html += `<span>íƒ€ì…: ${post.post_type}</span> | <span>ê²Œì‹œì¼: ${post.added ? formatDate(post.added) : '-'}</span> | <span>ìˆ˜ì •ì¼: ${post.updated ? formatDate(post.updated) : '-'}</span>`;
    html += `</div>`;
    html += `<div class='post-content'>${post.text}</div>`;
    if (post.post_type === "recruiting") {
        html += `<div>ëª¨ì§‘ ì¸ì›: ${post.capacity}</div>`;
        html += `<div>ì§€ì›ì ìˆ˜: ${post.applicants}</div>`;
        html += `<div>ëª¨ì§‘ ì‹œì‘ì¼: ${post.start_date ? formatDate(post.start_date) : '-'}</div>`;
        html += `<div>ëª¨ì§‘ ì¢…ë£Œì¼: ${post.end_date ? formatDate(post.end_date) : '-'}</div>`;
    } else if (post.post_type === "activity") {
        html += `<div>í™œë™ì¼: ${post.activity_day ? formatDate(post.activity_day) : '-'}</div>`;
        html += `<div>í™œë™ì‚¬ì§„: ${post.activity_image ? `<img src='${post.activity_image}' alt='í™œë™ì‚¬ì§„' style='max-width:200px;'/>` : 'ì—†ìŒ'}</div>`;
    } else if (post.post_type === "union") {
        html += `<div>ì—°í•©í™œë™ ì§€ì› ë™ì•„ë¦¬ ìˆ˜: ${post.applicants_club}</div>`;
        html += `<div>ëª¨ì§‘ ì‹œì‘ì¼: ${post.start_date ? formatDate(post.start_date) : '-'}</div>`;
        html += `<div>ëª¨ì§‘ ì¢…ë£Œì¼: ${post.end_date ? formatDate(post.end_date) : '-'}</div>`;
    }
    html += `<div style='font-size:12px;color:#bbb;'>ID: ${post.post_ID}</div>`;
    html += `</div>`;
    container.innerHTML = html;
}

async function fetchSinglePost(postID) {
    document.getElementById("singlePostResult").innerHTML = "ì¡°íšŒ ì¤‘...";
    try {
        const res = await fetch(`/user/get_posts/${postID}`);
        const data = await res.json();
        if (data.status === 1 && data.result) {
            renderSinglePost(data.result);
        } else {
            document.getElementById("singlePostResult").innerHTML = "ê²Œì‹œê¸€ì„ ì¡°íšŒí•˜ëŠ” ë„ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        }
    } catch (e) {
        document.getElementById("singlePostResult").innerHTML = "ê²Œì‹œê¸€ì„ ì¡°íšŒí•˜ëŠ” ë„ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
    }
}

document.getElementById("searchForm").onsubmit = function(e) {
    e.preventDefault();
    const clubName = document.getElementById("clubName").value.trim();
    const postType = document.getElementById("postType").value.trim();
    fetchPosts(clubName, postType);
};

document.getElementById("singlePostForm").onsubmit = function(e) {
    e.preventDefault();
    const postID = document.getElementById("singlePostID").value.trim();
    if (!postID) {
        showMessage("ê²Œì‹œê¸€ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        return;
    }
    fetchSinglePost(postID);
};
</script>
</body>
</html>
